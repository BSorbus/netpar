<%= form_for [@exam_fee], :html => { :role => 'form exam_fee' } do |f| %>

  <% input_disabled ||= false  
     #if input_disabled is not passed to the partial it doesn't crash. 
     # We default it to false 
  %>

  <%= form_errors_for @exam_fee %>


  <div class="row">
    <div class="col-sm-12">

      <div class="row">
        <div class="form-group col-sm-6">
          <%= f.label :category, 'Służba', class: 'control-label' %>
          <%= f.select :category, 
                options_for_select([['L - Świadectwo służby lotniczej', 'L'],
                                    ['M - ' + Proposal::CATEGORY_NAME_M, 'M'], 
                                    ['R - ' + Proposal::CATEGORY_NAME_R, 'R']], 
                    selected: @exam_fee.category || @exam_fee.division.category, disabled: ['L']), 
                { include_blank: true}, 
                { onchange: "change_category_select(this.options[this.selectedIndex].value);", 
                  autofocus: true, class: 'form-control input-sm', 
                  disabled: input_disabled  } %>

        </div>
      </div>  <!-- /row -->


      <div class="row">
        <div class="form-group col-sm-6">
          <%= f.label :division_id, class: "control-label" %>
          <%= f.hidden_field :division_id,
                            class: "form-control input-sm division_select", 
                            placeholder: "Wybierz Rodzaj",
                            disabled: input_disabled,
                            style: "width:100%",
                            id: "exam_fee_division_id", 
                            readonly: @exam_fee.category.blank?,
                            "data-category": "#{@exam_fee.category}" %>
        </div>
      </div> <!--/row -->


      <div class="row">
        <div class="form-group col-sm-6">
          <%= f.label :esod_category, class: 'control-label' %>
          <%= f.select :esod_category, 
                options_for_select([[Esodes::esod_matter_iks_name(Esodes::EGZAMIN), Esodes::EGZAMIN], 
                                    [Esodes::esod_matter_iks_name(Esodes::POPRAWKOWY), Esodes::POPRAWKOWY]], 
                    selected: @exam_fee.category || @exam_fee.esod_category), 
                { include_blank: true}, 
                { autofocus: false, 
                  class: 'form-control input-sm', 
                  disabled: input_disabled  } %>

        </div>
      </div>  <!-- /row -->



      <div class="row">
        <div class="form-group col-sm-3">
          <%= f.label :price, class: 'control-label' %>
          <%= f.text_field :price, class: 'form-control input-sm', disabled: input_disabled %>
        </div>

        <div class="form-group col-sm-3">
          <%= f.label :valid_from, class: 'control-label' %>
          <%= f.text_field :valid_from, class: 'datepicker form-control input-sm', disabled: input_disabled %>
        </div>

        <div class="form-group col-sm-3">
          <%= f.label :valid_to, class: 'control-label' %>
          <%= f.text_field :valid_to, class: 'datepicker form-control input-sm', disabled: input_disabled %>
        </div>

      </div>  <!-- /row -->


    </div>  <!-- /col-sm-12 -->
  </div>  <!-- /row -->

  <hr class="hr-without-top-margin">

  <% if input_disabled %>
    <!-- for "Show" -->
  <% else %>
    <!-- form "New"/"Edit" -->
    <div class="row">
      <%= link_to exam_fees_path(), class: "btn btn-default" do %>
        <span class="fa fa-list"></span>
        <%= t("helpers.links.index") %>
      <% end %>

      <%= link_to :back, class: "btn btn-default" do %>
        <span class="fa fa-undo"></span>
        <%= t("helpers.links.back") %>
      <% end %>


      <%= f.submit nil, :class => 'btn btn-success' %>
    </div> <!-- /row -->
  <% end %>
  
<% end %>


<script type="text/javascript">
  function change_category_select(category_code) {

    if (category_code !== "") {
      if (category_code !== $('#exam_fee_division_id').data('category')) {
        $('#exam_fee_division_id').data('category', category_code); 
        $('#exam_fee_division_id').select2("val", "");
        $("#exam_fee_division_id").select2("readonly", false);
      };
    } else {
      $('#exam_fee_division_id').data('category', ""); 
      $('#exam_fee_division_id').select2("val", "");
      $("#exam_fee_division_id").select2("readonly", true);

    };

  };  


  $(document).ready(function() {

   function divisionFormatResult(division, container, query, escapeMarkup) {
      if (division.id) {
        var markName = markMatch(division.data_obj.name, query.term)
        var markShortName = markMatch(division.data_obj.short_name, query.term)
        var markMinYearsOld = markMatch(division.data_obj.min_years_old.toString(), query.term)

        return  '<div>' + markName + 
                '<span class="pull-right">&nbsp[' + markShortName + ']</span><br>' +
                'min wiek: ' + markMinYearsOld + '<br>' +
                'nowe zgłoszenia: ' + division.data_obj.for_new_certificate + '</div>';

      } else {
        return "";
      }
    };

    function divisionFormatSelection(division) {
      if (division.id) {
        return  division.data_obj.category_fullname + ' ' + 
                division.data_obj.id_with_name_with_short + ' [' +
                division.data_obj.short_name + ']';
      } else {
        return "";
      }
    };

    $('.division_select').select2({
      minimumInputLength: 0,
      allowClear: false,
      ajax: {
        url: '/divisions/select2_index.json',
        dataType: 'json',
        quietMillis: 250,
        type: 'GET',
        data: function(term, page) {
          return {
            category: $('#exam_fee_division_id').data('category'),
            q: term,
            page_limit: 10,
            page: page
          };
        },
        results: function(data, page) {
          //var more = (page * 10) < data.total_count;
          var more = (page * 10) < data.meta.total_count;
          var divisions = $.map(data.divisions, function(division, i) {
            //return { data_obj: division, id: division.id, text: division.fullname };
            return { data_obj: division, id: division.id };
          });
          return { results: divisions, more: more };
        }
      },
      formatAjaxError: function(jqXHR, textStatus, errorThrown) {
        console.log(jqXHR);
        if (jqXHR.status == 401) {
          window.location.reload();
        } else {
          getErrorMessage(jqXHR, jqXHR.status);
        }
        return errorThrown + " " + jqXHR.responseText;
      },
      initSelection: function(element, callback) {
        var id=$(element).val();
        if (id!=="") {
          $.get("/divisions/"+id+".json", function(data_from_json) {
            if(data_from_json)
              //callback({ id: data_from_json.id, text: data_from_json.fullname });
              // or formatSelection: divisionFormatSelection and ... 
              callback({ data_obj: data_from_json, id: data_from_json.id, text: data_from_json.fullname });
          });
        }
      },
      formatResult: divisionFormatResult, // omitted for brevity, see the source of this page
      formatSelection: divisionFormatSelection, // omitted for brevity, see the source of this page
      dropdownCssClass: "bigdrop" // apply css that makes the dropdown taller
      //escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
    });


  });


</script>